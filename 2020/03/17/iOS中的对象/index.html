<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="站在巨人的肩膀，乘后人之凉">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS中的对象">
<meta property="og:url" content="onegoon.store/2020/03/17/iOS中的对象/index.html">
<meta property="og:site_name" content="斗扣年华">
<meta property="og:description" content="站在巨人的肩膀，乘后人之凉">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://www.sealiesoftware.com/blog/class diagram.pdf">
<meta property="og:image" content="https://raw.githubusercontent.com/oneGoon/Graphic/master/hexo-blog/iOS中的对象/iOSObjectCallStack0.png">
<meta property="og:image" content="https://github.com/oneGoon/Graphic/blob/master/hexo-blog/iOS%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1/os_object_init.png?raw=true">
<meta property="og:image" content="https://github.com/oneGoon/Graphic/blob/master/hexo-blog/iOS%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1/RootClass.png?raw=true">
<meta property="og:updated_time" content="2020-06-03T12:41:20.410Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS中的对象">
<meta name="twitter:description" content="站在巨人的肩膀，乘后人之凉">
<meta name="twitter:image" content="http://www.sealiesoftware.com/blog/class diagram.pdf">





  
  
  <link rel="canonical" href="onegoon.store/2020/03/17/iOS中的对象/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>iOS中的对象 | 斗扣年华</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">斗扣年华</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">与扣斗，其乐无穷</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/onegoon" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="onegoon.store/2020/03/17/iOS中的对象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="douCodeLife">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="斗扣年华">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS中的对象

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-03-17 15:23:24" itemprop="dateCreated datePublished" datetime="2020-03-17T15:23:24+08:00">2020-03-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-06-03 20:41:20" itemprop="dateModified" datetime="2020-06-03T20:41:20+08:00">2020-06-03</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><em>站在巨人的肩膀，乘后人之凉</em></p>
<a id="more"></a>
<p>分析OC代码，通用手段是用C++ rewrite，通过分析C++代码来了解OC compile time</p>
<p>先来份完整片段 </p>
<p>如下OC代码 <code>Alan.m</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;UIKit/UIKit.h&gt;</span><br><span class="line">#import &quot;AppDelegate.h&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface Human: NSObject</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Human</span><br><span class="line"></span><br><span class="line">- (void)breath &#123;</span><br><span class="line">    NSLog(@&quot;fresh air&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)eat &#123;</span><br><span class="line">    NSLog(@&quot;raw food&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface AlanWang: Human</span><br><span class="line"></span><br><span class="line">@property NSString *hack;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation AlanWang</span><br><span class="line"></span><br><span class="line">- (void)cook &#123;</span><br><span class="line">    NSLog(@&quot;then eat&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)swim &#123;</span><br><span class="line">    NSLog(@&quot;so much water&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    NSString * appDelegateClassName;</span><br><span class="line">    AlanWang *man = [AlanWang alloc];</span><br><span class="line">    man = [man init];</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        appDelegateClassName = NSStringFromClass([AppDelegate class]);</span><br><span class="line">    &#125;</span><br><span class="line">    return UIApplicationMain(argc, argv, nil, appDelegateClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>rewrite <code>xcrun -sdk iphoneos clang -rewrite-objc -F UIKit -fobjc-arc -arch arm64 Alan.m</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _REWRITER_typedef_Human</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _REWRITER_typedef_Human</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> <span class="title">Human</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>&#125; _objc_exc_Human;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Human_IMPL</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">NSObject_IMPL</span> <span class="title">NSObject_IVARS</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* @end */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// @implementation Human</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_Human_breath(Human * self, SEL _cmd) &#123;</span><br><span class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_1f_vycdcqqn5r32n45pwpqrj1gr0000gn_T_Alan_02f76f_mi_0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _C_Human_eat(Class self, SEL _cmd) &#123;</span><br><span class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_1f_vycdcqqn5r32n45pwpqrj1gr0000gn_T_Alan_02f76f_mi_1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _REWRITER_typedef_AlanWang</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _REWRITER_typedef_AlanWang</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> <span class="title">AlanWang</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>&#125; _objc_exc_AlanWang;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> OBJC_IVAR_$_AlanWang$_hack;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AlanWang_IMPL</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Human_IMPL</span> <span class="title">Human_IVARS</span>;</span></span><br><span class="line">	NSString *__strong _hack;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// @property NSString *hack;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* @end */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// @implementation AlanWang</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_AlanWang_cook(AlanWang * self, SEL _cmd) &#123;</span><br><span class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_1f_vycdcqqn5r32n45pwpqrj1gr0000gn_T_Alan_02f76f_mi_2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _C_AlanWang_swim(Class self, SEL _cmd) &#123;</span><br><span class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_1f_vycdcqqn5r32n45pwpqrj1gr0000gn_T_Alan_02f76f_mi_3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> NSString * _I_AlanWang_hack(AlanWang * self, SEL _cmd) &#123; <span class="keyword">return</span> (*(NSString *__strong *)((<span class="keyword">char</span> *)self + OBJC_IVAR_$_AlanWang$_hack)); &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_AlanWang_setHack_(AlanWang * self, SEL _cmd, NSString *hack) &#123; (*(NSString *__strong *)((<span class="keyword">char</span> *)self + OBJC_IVAR_$_AlanWang$_hack)) = hack; &#125;</span><br><span class="line"><span class="comment">// @end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    NSString * appDelegateClassName;</span><br><span class="line">    AlanWang *man = ((AlanWang *(*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="string">"AlanWang"</span>), sel_registerName(<span class="string">"alloc"</span>));</span><br><span class="line">    man = ((AlanWang *(*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)man, sel_registerName(<span class="string">"init"</span>));</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">        appDelegateClassName = NSStringFromClass(((Class (*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="string">"AppDelegate"</span>), sel_registerName(<span class="string">"class"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> UIApplicationMain(argc, argv, __null, appDelegateClassName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">prop_t</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *attributes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">protocol_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span> * _<span class="title">cmd</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *method_type;</span><br><span class="line">	<span class="keyword">void</span>  *_imp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">protocol_t</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> * isa;  <span class="comment">// NULL</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *protocol_name;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">protocol_list_t</span> * <span class="title">protocol_list</span>;</span> <span class="comment">// super protocols</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">instance_methods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">class_methods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">optionalInstanceMethods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> *<span class="title">optionalClassMethods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">prop_list_t</span> * <span class="title">properties</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> size;  <span class="comment">// sizeof(struct _protocol_t)</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;  <span class="comment">// = 0</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> ** extendedMethodTypes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">ivar_t</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *offset;  <span class="comment">// pointer to ivar offset location</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *type;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> alignment;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> instanceStart;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> instanceSize;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *ivarLayout;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">method_list_t</span> *<span class="title">baseMethods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">objc_protocol_list</span> *<span class="title">baseProtocols</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ivar_list_t</span> *<span class="title">ivars</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *weakIvarLayout;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">prop_list_t</span> *<span class="title">properties</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">isa</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">superclass</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *cache;</span><br><span class="line">	<span class="keyword">void</span> *vtable;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> *<span class="title">ro</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">category_t</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">cls</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">method_list_t</span> *<span class="title">instance_methods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">method_list_t</span> *<span class="title">class_methods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">prop_list_t</span> *<span class="title">properties</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="class"><span class="keyword">struct</span> <span class="title">objc_cache</span> _<span class="title">objc_empty_cache</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4273)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">method_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> <span class="title">method_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_INSTANCE_METHODS_Human __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;(struct objc_selector *)<span class="string">"breath"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_I_Human_breath&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">method_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> <span class="title">method_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_CLASS_METHODS_Human __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;(struct objc_selector *)<span class="string">"eat"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_C_Human_eat&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> _<span class="title">OBJC_METACLASS_RO_</span>$_<span class="title">Human</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_const</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">1</span>, <span class="keyword">sizeof</span>(struct <span class="keyword">_class_t</span>), <span class="keyword">sizeof</span>(struct <span class="keyword">_class_t</span>), </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="string">"Human"</span>,</span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_method_list_t</span> *)&amp;_OBJC_$_CLASS_METHODS_Human,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> _<span class="title">OBJC_CLASS_RO_</span>$_<span class="title">Human</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_const</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">0</span>, <span class="keyword">sizeof</span>(struct Human_IMPL), <span class="keyword">sizeof</span>(struct Human_IMPL), </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="string">"Human"</span>,</span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_method_list_t</span> *)&amp;_OBJC_$_INSTANCE_METHODS_Human,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_METACLASS_</span>$_<span class="title">NSObject</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_METACLASS_</span>$_<span class="title">Human</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_data</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_NSObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_NSObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// (void *)&amp;_objc_empty_cache,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// unused, was (void *)&amp;_objc_empty_vtable,</span></span><br><span class="line">	&amp;_OBJC_METACLASS_RO_$_Human,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_CLASS_</span>$_<span class="title">NSObject</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_CLASS_</span>$_<span class="title">Human</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_data</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_Human,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_NSObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// (void *)&amp;_objc_empty_cache,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// unused, was (void *)&amp;_objc_empty_vtable,</span></span><br><span class="line">	&amp;_OBJC_CLASS_RO_$_Human,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> OBJC_CLASS_SETUP_$_Human(<span class="keyword">void</span> ) &#123;</span><br><span class="line">	OBJC_METACLASS_$_Human.isa = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_Human.superclass = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_Human.cache = &amp;_objc_empty_cache;</span><br><span class="line">	OBJC_CLASS_$_Human.isa = &amp;OBJC_METACLASS_$_Human;</span><br><span class="line">	OBJC_CLASS_$_Human.superclass = &amp;OBJC_CLASS_$_NSObject;</span><br><span class="line">	OBJC_CLASS_$_Human.cache = &amp;_objc_empty_cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> OBJC_IVAR_$_AlanWang$_hack __attribute__ ((used, section (<span class="string">"__DATA,__objc_ivar"</span>))) = __OFFSETOFIVAR__(struct AlanWang, _hack);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">ivar_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _prop_t)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">ivar_t</span> <span class="title">ivar_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_INSTANCE_VARIABLES_AlanWang __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(<span class="keyword">_ivar_t</span>),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> *)&amp;OBJC_IVAR_$_AlanWang$_hack, <span class="string">"_hack"</span>, <span class="string">"@\"NSString\""</span>, <span class="number">3</span>, <span class="number">8</span>&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">method_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> <span class="title">method_list</span>[3];</span></span><br><span class="line">&#125; _OBJC_$_INSTANCE_METHODS_AlanWang __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line">	<span class="number">3</span>,</span><br><span class="line">	&#123;&#123;(struct objc_selector *)<span class="string">"cook"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_I_AlanWang_cook&#125;,</span><br><span class="line">	&#123;(struct objc_selector *)<span class="string">"hack"</span>, <span class="string">"@16@0:8"</span>, (<span class="keyword">void</span> *)_I_AlanWang_hack&#125;,</span><br><span class="line">	&#123;(struct objc_selector *)<span class="string">"setHack:"</span>, <span class="string">"v24@0:8@16"</span>, (<span class="keyword">void</span> *)_I_AlanWang_setHack_&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">method_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> <span class="title">method_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_CLASS_METHODS_AlanWang __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;(struct objc_selector *)<span class="string">"swim"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_C_AlanWang_swim&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">prop_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _prop_t)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count_of_properties;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">prop_t</span> <span class="title">prop_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_PROP_LIST_AlanWang __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(<span class="keyword">_prop_t</span>),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;<span class="string">"hack"</span>,<span class="string">"T@\"NSString\",&amp;,V_hack"</span>&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> _<span class="title">OBJC_METACLASS_RO_</span>$_<span class="title">AlanWang</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_const</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">1</span>, <span class="keyword">sizeof</span>(struct <span class="keyword">_class_t</span>), <span class="keyword">sizeof</span>(struct <span class="keyword">_class_t</span>), </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="string">"AlanWang"</span>,</span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_method_list_t</span> *)&amp;_OBJC_$_CLASS_METHODS_AlanWang,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> _<span class="title">OBJC_CLASS_RO_</span>$_<span class="title">AlanWang</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_const</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">0</span>, __OFFSETOFIVAR__(struct AlanWang, _hack), <span class="keyword">sizeof</span>(struct AlanWang_IMPL), </span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	<span class="string">"AlanWang"</span>,</span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_method_list_t</span> *)&amp;_OBJC_$_INSTANCE_METHODS_AlanWang,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_ivar_list_t</span> *)&amp;_OBJC_$_INSTANCE_VARIABLES_AlanWang,</span><br><span class="line">	<span class="number">0</span>, </span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_prop_list_t</span> *)&amp;_OBJC_$_PROP_LIST_AlanWang,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_METACLASS_</span>$_<span class="title">Human</span>;</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllimport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_METACLASS_</span>$_<span class="title">NSObject</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_METACLASS_</span>$_<span class="title">AlanWang</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_data</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_NSObject,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_Human,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// (void *)&amp;_objc_empty_cache,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// unused, was (void *)&amp;_objc_empty_vtable,</span></span><br><span class="line">	&amp;_OBJC_METACLASS_RO_$_AlanWang,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_CLASS_</span>$_<span class="title">Human</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_CLASS_</span>$_<span class="title">AlanWang</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_data</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_AlanWang,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_Human,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// (void *)&amp;_objc_empty_cache,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// unused, was (void *)&amp;_objc_empty_vtable,</span></span><br><span class="line">	&amp;_OBJC_CLASS_RO_$_AlanWang,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> OBJC_CLASS_SETUP_$_AlanWang(<span class="keyword">void</span> ) &#123;</span><br><span class="line">	OBJC_METACLASS_$_AlanWang.isa = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_AlanWang.superclass = &amp;OBJC_METACLASS_$_Human;</span><br><span class="line">	OBJC_METACLASS_$_AlanWang.cache = &amp;_objc_empty_cache;</span><br><span class="line">	OBJC_CLASS_$_AlanWang.isa = &amp;OBJC_METACLASS_$_AlanWang;</span><br><span class="line">	OBJC_CLASS_$_AlanWang.superclass = &amp;OBJC_CLASS_$_Human;</span><br><span class="line">	OBJC_CLASS_$_AlanWang.cache = &amp;_objc_empty_cache;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> section(<span class="meta-string">".objc_inithooks$B"</span>, long, read, write)</span></span><br><span class="line">__declspec(allocate(<span class="string">".objc_inithooks$B"</span>)) <span class="keyword">static</span> <span class="keyword">void</span> *OBJC_CLASS_SETUP[] = &#123;</span><br><span class="line">	(<span class="keyword">void</span> *)&amp;OBJC_CLASS_SETUP_$_Human,</span><br><span class="line">	(<span class="keyword">void</span> *)&amp;OBJC_CLASS_SETUP_$_AlanWang,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">L_OBJC_LABEL_CLASS_</span>$ [2] __<span class="title">attribute__</span>((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>, __<span class="title">objc_classlist</span>,<span class="title">regular</span>,<span class="title">no_dead_strip</span>")))= &#123;</span></span><br><span class="line">	&amp;OBJC_CLASS_$_Human,</span><br><span class="line">	&amp;OBJC_CLASS_$_AlanWang,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">IMAGE_INFO</span> &#123;</span> <span class="keyword">unsigned</span> version; <span class="keyword">unsigned</span> flag; &#125; _OBJC_IMAGE_INFO = &#123; <span class="number">0</span>, <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>可以搜索关键字AlanWang来定位代码，当然往往都在最下面</p>
<p>不难发现c++重写后OC类被加了前缀</p>
<p><code>OBJC_CLASS_REF_$_</code></p>
<p><code>OBJC_CLASS_$_</code></p>
<p><code>OBJC_METACLASS_$_</code></p>
<p>查阅Swift源码可见的确是这些前缀。可见在rewrite过程中总会被加一些标识前缀，所以阅读时自行转化前缀</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// An Objective-C class reference reference. The symbol is private, so</span></span><br><span class="line">  <span class="comment">// the mangling is unimportant; it should just be readable in LLVM IR.</span></span><br><span class="line"><span class="keyword">case</span> Kind::ObjCClassRef: &#123;</span><br><span class="line">  llvm::SmallString&lt;<span class="number">64</span>&gt; tempBuffer;</span><br><span class="line">  StringRef name = cast&lt;ClassDecl&gt;(getDecl())-&gt;getObjCRuntimeName(tempBuffer);</span><br><span class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">Result</span><span class="params">(<span class="string">"OBJC_CLASS_REF_$_"</span>)</span></span>;</span><br><span class="line">  Result.append(name.data(), name.size());</span><br><span class="line">  <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// An Objective-C class reference;  not a swift mangling.</span></span><br><span class="line"><span class="keyword">case</span> Kind::ObjCClass: &#123;</span><br><span class="line">  llvm::SmallString&lt;<span class="number">64</span>&gt; TempBuffer;</span><br><span class="line">  StringRef Name = cast&lt;ClassDecl&gt;(getDecl())-&gt;getObjCRuntimeName(TempBuffer);</span><br><span class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">Result</span><span class="params">(<span class="string">"OBJC_CLASS_$_"</span>)</span></span>;</span><br><span class="line">  Result.append(Name.data(), Name.size());</span><br><span class="line">  <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// An Objective-C metaclass reference;  not a swift mangling.</span></span><br><span class="line"><span class="keyword">case</span> Kind::ObjCMetaclass: &#123;</span><br><span class="line">  llvm::SmallString&lt;<span class="number">64</span>&gt; TempBuffer;</span><br><span class="line">  StringRef Name = cast&lt;ClassDecl&gt;(getDecl())-&gt;getObjCRuntimeName(TempBuffer);</span><br><span class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">Result</span><span class="params">(<span class="string">"OBJC_METACLASS_$_"</span>)</span></span>;</span><br><span class="line">  Result.append(Name.data(), Name.size());</span><br><span class="line">  <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先来看两个类的初始化方法</p>
<blockquote>
<p>extern “C”  的意思是把它当做C语言编译</p>
<p>比如C++支持重载，而C不支持</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_CLASS_</span>$_<span class="title">Human</span>;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(dllexport) <span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> <span class="title">OBJC_CLASS_</span>$_<span class="title">AlanWang</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_data</span>"))) = &#123;</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_METACLASS_$_AlanWang,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_Human,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// (void *)&amp;_objc_empty_cache,</span></span><br><span class="line">	<span class="number">0</span>, <span class="comment">// unused, was (void *)&amp;_objc_empty_vtable,</span></span><br><span class="line">	&amp;_OBJC_CLASS_RO_$_AlanWang,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>AlanWang 这个类被存在<code>&quot;__DATA, __objc_classlist,regular,no_dead_strip&quot;</code>section中</p>
<h6 id="class-t"><a href="#class-t" class="headerlink" title="_class_t"></a>_class_t</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">isa</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">superclass</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *cache;</span><br><span class="line">	<span class="keyword">void</span> *vtable;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> *<span class="title">ro</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>_class_t 的 isa 和 superclass 指向 _class_t </p>
<h6 id="SETUP-AlanWang"><a href="#SETUP-AlanWang" class="headerlink" title="SETUP AlanWang"></a>SETUP AlanWang</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> OBJC_CLASS_SETUP_$_AlanWang(<span class="keyword">void</span> ) &#123;</span><br><span class="line">	OBJC_METACLASS_$_AlanWang.isa = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_AlanWang.superclass = &amp;OBJC_METACLASS_$_Human;</span><br><span class="line">	OBJC_METACLASS_$_AlanWang.cache = &amp;_objc_empty_cache;</span><br><span class="line">	OBJC_CLASS_$_AlanWang.isa = &amp;OBJC_METACLASS_$_AlanWang;</span><br><span class="line">	OBJC_CLASS_$_AlanWang.superclass = &amp;OBJC_CLASS_$_Human;</span><br><span class="line">	OBJC_CLASS_$_AlanWang.cache = &amp;_objc_empty_cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="SETUP-Human"><a href="#SETUP-Human" class="headerlink" title="SETUP Human"></a>SETUP Human</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> OBJC_CLASS_SETUP_$_Human(<span class="keyword">void</span> ) &#123;</span><br><span class="line">	OBJC_METACLASS_$_Human.isa = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_Human.superclass = &amp;OBJC_METACLASS_$_NSObject;</span><br><span class="line">	OBJC_METACLASS_$_Human.cache = &amp;_objc_empty_cache;</span><br><span class="line">	OBJC_CLASS_$_Human.isa = &amp;OBJC_METACLASS_$_Human;</span><br><span class="line">	OBJC_CLASS_$_Human.superclass = &amp;OBJC_CLASS_$_NSObject;</span><br><span class="line">	OBJC_CLASS_$_Human.cache = &amp;_objc_empty_cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一图胜千言。</p>
<p><img src="http://www.sealiesoftware.com/blog/class diagram.pdf" alt="OC中类的关系图"></p>
<h6 id="class-ro-t"><a href="#class-ro-t" class="headerlink" title="_class_ro_t"></a>_class_ro_t</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> instanceStart;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> instanceSize;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *ivarLayout;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">method_list_t</span> *<span class="title">baseMethods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">objc_protocol_list</span> *<span class="title">baseProtocols</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ivar_list_t</span> *<span class="title">ivars</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *weakIvarLayout;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">prop_list_t</span> *<span class="title">properties</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ro   readonly</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span> * _<span class="title">cmd</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *method_type;</span><br><span class="line">	<span class="keyword">void</span>  *_imp;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通观全文，不难发现并未找到<code>alloc</code>方法的声明与实现</p>
<p>main函数中的实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    NSString * appDelegateClassName;</span><br><span class="line">    AlanWang *man = ((AlanWang *(*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="string">"AlanWang"</span>), sel_registerName(<span class="string">"alloc"</span>));</span><br><span class="line">    man = ((AlanWang *(*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)man, sel_registerName(<span class="string">"init"</span>));</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到运行时dyld通知回调时执行map_images时才会注册alloc方法</p>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1" target="_blank" rel="noopener">Type Encodings</a></p>
<h3 id="运行时体系结构（Runtime-Architecture）"><a href="#运行时体系结构（Runtime-Architecture）" class="headerlink" title="运行时体系结构（Runtime Architecture）"></a>运行时体系结构（Runtime Architecture）</h3><p>具有关键的一些方面</p>
<ul>
<li>提供了用于启动和执行程序的工具</li>
<li>指定了代码和数据怎样驻留在磁盘上—-也就是说，它制定了二进制格式。它还指定了编译器和相关工具必须怎样生成代码和数据</li>
<li>指定了怎样将代码和数据加载进内存中</li>
<li>指定了怎样解析指向外部库的引用</li>
</ul>
<p>Mac OS X  &amp; iOS 运行时环境： Mach-O</p>
<h3 id="对象的诞生"><a href="#对象的诞生" class="headerlink" title="对象的诞生"></a>对象的诞生</h3><p>objc_getClass</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* objc_getClass.  Return the id of the named class.  If the class does</span></span><br><span class="line"><span class="comment">* not exist, call _objc_classLoader and then objc_classHandler, either of </span></span><br><span class="line"><span class="comment">* which may create a new class.</span></span><br><span class="line"><span class="comment">* Warning: doesn't work if aClassName is the name of a posed-for class's isa!</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function">Class <span class="title">objc_getClass</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *aClassName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!aClassName) <span class="keyword">return</span> Nil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NO unconnected, YES class handler</span></span><br><span class="line">    <span class="keyword">return</span> look_up_class(aClassName, NO, YES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提供类名到类映射的哈希表</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Maps class name to Class, for in-use classes only. NXStrValueMapPrototype.</span></span><br><span class="line">OBJC_EXPORT NXMapTable * _Nullable gdb_objc_realized_classes</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.6</span>, <span class="number">3.1</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">getClass_impl</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocated in _read_images</span></span><br><span class="line">    assert(gdb_objc_realized_classes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try runtime-allocated table</span></span><br><span class="line">    Class result = (Class)NXMapGet(gdb_objc_realized_classes, name);</span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try table from dyld shared cache</span></span><br><span class="line">    <span class="keyword">return</span> getPreoptimizedClass(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _read_images</span></span><br><span class="line"><span class="comment">* Perform initial processing of the headers in the linked </span></span><br><span class="line"><span class="comment">* list beginning with headerList. </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Called by: map_images_nolock</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock acquired by map_images</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_getClass_read_images</span><span class="params">(header_info **hList, <span class="keyword">uint32_t</span> hCount, <span class="keyword">int</span> totalClasses, <span class="keyword">int</span> unoptimizedTotalClasses)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">    readClass</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>_objc_init–&gt;map_images –&gt; map_images_nolock –&gt; _read_images </p>
<p>objc_getClass：通过key= className 在哈希表（gdb_objc_realized_classes）找到 Class </p>
<p>sel_registerName：通过key= selectorName 在哈希表（namedSelectors ）找到SEL</p>
<p>objc_msgSend： 参数为Class 与 SEL</p>
<p>objc_msgSend伪代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/********************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * id objc_msgSend(id self, SEL _cmd, ...);</span></span><br><span class="line"><span class="comment"> * IMP objc_msgLookup(id self, SEL _cmd, ...);</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * objc_msgLookup ABI:</span></span><br><span class="line"><span class="comment"> * IMP returned in x17</span></span><br><span class="line"><span class="comment"> * x16 reserved for our use but not used</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> ********************************************************************/</span></span><br><span class="line"> </span><br><span class="line"> <span class="function">id <span class="title">objc_msgSend</span><span class="params">(id self, SEL _cmd, ...)</span> </span>&#123;</span><br><span class="line">  Class <span class="class"><span class="keyword">class</span> = <span class="title">object_getClass</span>(<span class="title">self</span>);</span></span><br><span class="line">  IMP imp = class_getMethodImplementation(class, _cmd);</span><br><span class="line">  <span class="keyword">return</span> imp ? imp(self, _cmd, ...) : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在cache中找</p>
<p>在类的方法列表中找</p>
<p>消息转发</p>
<p>终于找到alloc方法了</p>
<h5 id="运行时类的结构"><a href="#运行时类的结构" class="headerlink" title="运行时类的结构"></a>运行时类的结构</h5><p><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">objc源代码下载</a></p>
<p>目前最新的是objc4-779.1</p>
<p><code>objc.h</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	objc.h</span></span><br><span class="line"><span class="comment"> *	Copyright 1988-1996, NeXT Software, Inc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !OBJC_TYPES_DEFINED</span></span><br><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> *<span class="title">id</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// An opaque type that represents a method selector.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span> *<span class="title">SEL</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to the function of a method implementation. </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !OBJC_OLD_DISPATCH_PROTOTYPES</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*IMP)</span><span class="params">(<span class="keyword">void</span> <span class="comment">/* id, SEL, ... */</span> )</span></span>; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> id _Nullable (*IMP)(id _Nonnull, SEL _Nonnull, ...); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>Class 意为一个不透明的类型（指针） 代表一个Objective-C的类</p>
<p>id 意为类的实例的指针</p>
<p>SEL 意为一个不透明的类型 代表一个方法选择器</p>
<p>IMP 意为方法实现的函数指针</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	objc-api.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* OBJC_OLD_DISPATCH_PROTOTYPES == 0 enforces the rule that the dispatch </span></span><br><span class="line"><span class="comment"> * functions must be cast to an appropriate function pointer type. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(OBJC_OLD_DISPATCH_PROTOTYPES)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">if</span> __swift__</span></span><br><span class="line">        <span class="comment">// Existing Swift code expects IMP to be Comparable.</span></span><br><span class="line">        <span class="comment">// Variadic IMP is comparable via OpaquePointer; non-variadic IMP isn't.</span></span><br><span class="line"><span class="meta">#       <span class="meta-keyword">define</span> OBJC_OLD_DISPATCH_PROTOTYPES 1</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#       <span class="meta-keyword">define</span> OBJC_OLD_DISPATCH_PROTOTYPES 0</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>如果有swift的代码。则可变的IMP是不透明指针，不可变则不是。</p>
<p>OBJC_TYPES_DEFINED` 宏定义是因为在另一处</p>
<p><code>objc-private.h</code>中也有声明 避免重复定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *    objc-private.h</span></span><br><span class="line"><span class="comment"> *    Copyright 1988-1996, NeXT Software, Inc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> OBJC_TYPES_DEFINED 1</span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> *<span class="title">id</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"isa.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">isa_t</span> &#123;</span><br><span class="line">    <span class="keyword">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="keyword">isa_t</span>(<span class="keyword">uintptr_t</span> value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="keyword">uintptr_t</span> bits;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ISA_BITFIELD)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h6 id="Meta-元类"><a href="#Meta-元类" class="headerlink" title="Meta 元类"></a>Meta 元类</h6><h1 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h1><h3 id="objc-config-h中的宏"><a href="#objc-config-h中的宏" class="headerlink" title="objc-config.h中的宏"></a>objc-config.h中的宏</h3><h5 id="LP64"><a href="#LP64" class="headerlink" title="__LP64__"></a><code>__LP64__</code></h5><p>字长为64位的操作系统</p>
<p>在 XL C/C++ V10.1 中添加了四个新宏：</p>
<ul>
<li><p>_ILP32 <code>__ILP32__</code></p>
<p>仅当对一个目标进行编译时，才可定义为 1，其中该目标的 long int，int 和指针使用的都是 32 位。否则， 不能对它定义。</p>
</li>
<li><p>_LP64 <code>__LP64__</code></p>
<p>仅当对一个目标进行编译时，才可定义为 1，其中该目标的 long int 和指针使用的都是 64 位而 int 使用的是 32 位。否则， 不能对它定义。</p>
<p><a href="https://www.ibm.com/support/knowledgecenter/zh/SSXVZZ_13.1.0/com.ibm.xlcpp131.linux.doc/getstart/predef_macro_v10v12.html" target="_blank" rel="noopener">https://www.ibm.com/support/knowledgecenter/zh/SSXVZZ_13.1.0/com.ibm.xlcpp131.linux.doc/getstart/predef_macro_v10v12.html</a></p>
<p>与编译器运行的平台有关，利用clang可以查看对应的宏定义</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  / clang -dM -E -x c /dev/null</span><br><span class="line">#define OBJC_NEW_PROPERTIES 1</span><br><span class="line">#define _LP64 1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h5 id="arm"><a href="#arm" class="headerlink" title="__arm__"></a><code>__arm__</code></h5><p>32-bit ARM</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __PTRAUTH_INTRINSICS__</span></span><br><span class="line"><span class="comment">// Always use ptrauth when it's supported.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CACHE_IMP_ENCODING CACHE_IMP_ENCODING_PTRAUTH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__arm__)</span></span><br><span class="line"><span class="comment">// 32-bit ARM uses no encoding.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CACHE_IMP_ENCODING CACHE_IMP_ENCODING_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// Everything else uses ISA ^ IMP.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CACHE_IMP_ENCODING CACHE_IMP_ENCODING_ISA_XOR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h5 id="SUPPORT-PACKED-ISA"><a href="#SUPPORT-PACKED-ISA" class="headerlink" title="SUPPORT_PACKED_ISA"></a>SUPPORT_PACKED_ISA</h5><p>isa 视为被数据包裹的可以掩码化的指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define SUPPORT_PACKED_ISA=1 on platforms that store the class in the isa </span></span><br><span class="line"><span class="comment">// field as a maskable pointer with other data around it.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (!__LP64__  ||  TARGET_OS_WIN32  ||  \</span></span><br><span class="line">     (TARGET_OS_SIMULATOR &amp;&amp; !TARGET_OS_IOSMAC))</span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_PACKED_ISA 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_PACKED_ISA 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>iOS中为1</p>
<h5 id="SUPPORT-TAGGED-POINTERS"><a href="#SUPPORT-TAGGED-POINTERS" class="headerlink" title="SUPPORT_TAGGED_POINTERS"></a>SUPPORT_TAGGED_POINTERS</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define SUPPORT_TAGGED_POINTERS=1 to enable tagged pointer objects</span></span><br><span class="line"><span class="comment">// Be sure to edit tagged pointer SPI in objc-internal.h as well.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(__OBJC2__  &amp;&amp;  __LP64__)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_TAGGED_POINTERS 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_TAGGED_POINTERS 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>iOS中为1</p>
<h5 id="SUPPORT-INDEXED-ISA"><a href="#SUPPORT-INDEXED-ISA" class="headerlink" title="SUPPORT_INDEXED_ISA"></a>SUPPORT_INDEXED_ISA</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define SUPPORT_INDEXED_ISA=1 on platforms that store the class in the isa </span></span><br><span class="line"><span class="comment">// field as an index into a class table.</span></span><br><span class="line"><span class="comment">// Note, keep this in sync with any .s files which also define it.</span></span><br><span class="line"><span class="comment">// Be sure to edit objc-abi.h as well.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __ARM_ARCH_7K__ &gt;= 2  ||  (__arm64__ &amp;&amp; !__LP64__)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_INDEXED_ISA 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_INDEXED_ISA 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>iOS中为0</p>
<p><code>(__arm64__ &amp;&amp; !__LP64__)</code> 这个条件为了兼容32位系统？</p>
<h5 id="SUPPORT-PACKED-ISA-1"><a href="#SUPPORT-PACKED-ISA-1" class="headerlink" title="SUPPORT_PACKED_ISA"></a>SUPPORT_PACKED_ISA</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define SUPPORT_PACKED_ISA=1 on platforms that store the class in the isa </span></span><br><span class="line"><span class="comment">// field as a maskable pointer with other data around it.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (!__LP64__  ||  TARGET_OS_WIN32  ||  \</span></span><br><span class="line">     (TARGET_OS_SIMULATOR &amp;&amp; !TARGET_OS_IOSMAC))</span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_PACKED_ISA 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_PACKED_ISA 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>iOS中为1</p>
<h5 id="SUPPORT-NONPOINTER-ISA"><a href="#SUPPORT-NONPOINTER-ISA" class="headerlink" title="SUPPORT_NONPOINTER_ISA"></a>SUPPORT_NONPOINTER_ISA</h5><p>可能在isa中存有额外的数据，支持所有平台</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define SUPPORT_NONPOINTER_ISA=1 on any platform that may store something</span></span><br><span class="line"><span class="comment">// in the isa field that is not a raw pointer.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !SUPPORT_INDEXED_ISA  &amp;&amp;  !SUPPORT_PACKED_ISA</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_NONPOINTER_ISA 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_NONPOINTER_ISA 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h5 id="SUPPORT-FIXUP"><a href="#SUPPORT-FIXUP" class="headerlink" title="SUPPORT_FIXUP"></a>SUPPORT_FIXUP</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Define SUPPORT_FIXUP=1 to repair calls sites for fixup dispatch.</span><br><span class="line">// Fixup messaging itself is no longer supported.</span><br><span class="line">// Be sure to edit objc-abi.h as well (objc_msgSend*_fixup)</span><br><span class="line">#if !(defined(__x86_64__) &amp;&amp; (TARGET_OS_OSX || TARGET_OS_SIMULATOR))</span><br><span class="line">#   define SUPPORT_FIXUP 0</span><br><span class="line">#else</span><br><span class="line">#   define SUPPORT_FIXUP 1</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h5 id="SUPPORT-ZEROCOST-EXCEPTIONS"><a href="#SUPPORT-ZEROCOST-EXCEPTIONS" class="headerlink" title="SUPPORT_ZEROCOST_EXCEPTIONS"></a>SUPPORT_ZEROCOST_EXCEPTIONS</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Define SUPPORT_ZEROCOST_EXCEPTIONS to use &quot;zero-cost&quot; exceptions for OBJC2.</span><br><span class="line">// Be sure to edit objc-exception.h as well (objc_add/removeExceptionHandler)</span><br><span class="line">#if !__OBJC2__  ||  (defined(__arm__)  &amp;&amp;  __USING_SJLJ_EXCEPTIONS__)</span><br><span class="line">#   define SUPPORT_ZEROCOST_EXCEPTIONS 0</span><br><span class="line">#else</span><br><span class="line">#   define SUPPORT_ZEROCOST_EXCEPTIONS 1</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h5 id="ISA-BITFIELD-RC-ONE-RC-HALF"><a href="#ISA-BITFIELD-RC-ONE-RC-HALF" class="headerlink" title="ISA_BITFIELD, RC_ONE, RC_HALF"></a>ISA_BITFIELD, RC_ONE, RC_HALF</h5><p>前文提到iOS中SUPPORT_PACKED_ISA为1，所以iOS64位机中isa的相关字段定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_PACKED_ISA</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// extra_rc must be the MSB-most field (so it matches carry/overflow flags)</span></span><br><span class="line">    <span class="comment">// nonpointer must be the LSB (fixme or get rid of it)</span></span><br><span class="line">    <span class="comment">// shiftcls must occupy the same bits that a real class pointer would</span></span><br><span class="line">    <span class="comment">// bits + RC_ONE is equivalent to extra_rc + 1</span></span><br><span class="line">    <span class="comment">// RC_HALF is the high bit of extra_rc (i.e. half of its range)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// future expansion:</span></span><br><span class="line">    <span class="comment">// uintptr_t fast_rr : 1;     // no r/r overrides</span></span><br><span class="line">    <span class="comment">// uintptr_t lock : 2;        // lock for atomic property, @synch</span></span><br><span class="line">    <span class="comment">// uintptr_t extraBytes : 1;  // allocated with extra bytes</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">if</span> __arm64__</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x000003f000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x000001a000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_BITFIELD                                                      \</span></span><br><span class="line">      <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> has_assoc         : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</span><br><span class="line">      <span class="keyword">uintptr_t</span> magic             : <span class="number">6</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> weakly_referenced : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> deallocating      : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> extra_rc          : <span class="number">19</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;45)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;18)</span></span><br></pre></td></tr></table></figure>
<p>MSB: most significant bit 最高有效位（最左位）</p>
<p>LSB: least significant bit 最低有效位</p>
<h5 id="ISA-MAGIC-VALUE"><a href="#ISA-MAGIC-VALUE" class="headerlink" title="ISA_MAGIC_VALUE"></a>ISA_MAGIC_VALUE</h5><p>0x000001a000000001ULL</p>
<h5 id="TaggedPointer"><a href="#TaggedPointer" class="headerlink" title="TaggedPointer"></a>TaggedPointer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#if (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__</span><br><span class="line">    // 64-bit Mac - tag bit is LSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 0</span><br><span class="line">#else</span><br><span class="line">    // Everything else - tag bit is MSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 1</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>只有64位 Mac 上是LSB 也就是看最低位</p>
<p>iOS中看MSB 也就是最高位（第63位）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OBJC_MSB_TAGGED_POINTERS</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK (1UL&lt;&lt;63)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_INDEX_SHIFT 60</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_SLOT_SHIFT 60</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_PAYLOAD_LSHIFT 4</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_PAYLOAD_RSHIFT 4</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_MASK (0xfUL&lt;&lt;60)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_INDEX_SHIFT 52</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_SLOT_SHIFT 52</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_PAYLOAD_LSHIFT 12</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK 1UL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_INDEX_SHIFT 1</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_SLOT_SHIFT 0</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_PAYLOAD_LSHIFT 0</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_PAYLOAD_RSHIFT 4</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_MASK 0xfUL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_INDEX_SHIFT 4</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_SLOT_SHIFT 4</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_PAYLOAD_LSHIFT 0</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><p><code>libdispatch_init</code> -&gt; <code>_os_object_init</code> -&gt; <code>_objc_init</code> —[_dyld_objc_notify_register(&amp;map_images, load_images, unmap_image)] —&gt; <code></code></p>
<p>dyld 通知 -&gt; (map_images,load_images,unmap_image)</p>
<p>map_images-&gt;arr_init-&gt;</p>
<p> AutoreleasePoolPage::init(); -&gt; 注册析构到对应线程</p>
<p>  SideTableInit();-&gt;</p>
<p><code>realizeClassWithoutSwift</code> </p>
<p><code>addRootClass(cls);</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 没有supercls的根类</span></span><br><span class="line">(Class) $0 = NSObject</span><br><span class="line">(Class) $1 = __NSAtom</span><br><span class="line">(Class) $2 = NSProxy</span><br><span class="line">-&lt;main&gt;-</span><br><span class="line">(Class) $3 = Object</span><br><span class="line">(Class) $4 = __NSMessageBuilder</span><br><span class="line">(Class) $5 = _NSZombie_</span><br><span class="line">(Class) $6 = __NSGenericDeallocHandler</span><br><span class="line">(Class) $7 = NSLeafProxy</span><br><span class="line">(Class) $8 = JSExport</span><br><span class="line">(Class) $9 = _CNZombie_</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/oneGoon/Graphic/master/hexo-blog/iOS中的对象/iOSObjectCallStack0.png" alt="调用堆栈" style="zoom:50%;"></p>
<h4 id="从dyld进入到libSystem"><a href="#从dyld进入到libSystem" class="headerlink" title="从dyld进入到libSystem"></a>从dyld进入到libSystem</h4><p>先看ImageLoaderMachO::doModInitFunctions</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Initializer* inits = (Initializer*)(sect-&gt;addr + fSlide);</span><br><span class="line">const size_t count = sect-&gt;size / sizeof(uintptr_t);</span><br></pre></td></tr></table></figure>
<p>通过这两句得到<strong>libSystem.B.dylib</strong><code>__mod_init_funcs</code>section inits数组，元素类型为Initializer* 函数指针类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// dyld/src/ImageLoader.h</span><br><span class="line">typedef void (*Initializer)(int argc, const char* argv[], const char* envp[], const char* apple[], const ProgramVars* vars);</span><br></pre></td></tr></table></figure>
<p><code>otool -l /usr/lib/libSystem.dylib</code>查看libSystem依赖的库</p>
<p>libSystem.dylib会加载libSystem.B.dylib</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  otool -L  /usr/lib/libSystem.dylib</span><br><span class="line">/usr/lib/libSystem.dylib:</span><br><span class="line">	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.250.1)</span><br><span class="line">	/usr/lib/system/libcache.dylib (compatibility version 1.0.0, current version 81.0.0)</span><br><span class="line">	/usr/lib/system/libcommonCrypto.dylib (compatibility version 1.0.0, current version 60118.250.2)</span><br><span class="line">	/usr/lib/system/libcompiler_rt.dylib (compatibility version 1.0.0, current version 63.4.0)</span><br><span class="line">	/usr/lib/system/libcopyfile.dylib (compatibility version 1.0.0, current version 1.0.0)</span><br><span class="line">	/usr/lib/system/libcorecrypto.dylib (compatibility version 1.0.0, current version 602.255.2)</span><br><span class="line">	/usr/lib/system/libdispatch.dylib (compatibility version 1.0.0, current version 1008.255.1)</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<p>查看load commands</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ otool -l /usr/lib/libSystem.B.dylib</span><br><span class="line">/usr/lib/libSystem.B.dylib:</span><br><span class="line">...</span><br><span class="line">Section</span><br><span class="line">  sectname __mod_init_func</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000000002218</span><br><span class="line">      size 0x0000000000000008</span><br><span class="line">    offset 8728</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x00000009</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p>otool -l /usr/lib/libSystem.dylib`</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Section</span><br><span class="line">  sectname __mod_init_func</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000000002218</span><br><span class="line">      size 0x0000000000000008</span><br><span class="line">    offset 8728</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x00000009</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br></pre></td></tr></table></figure>
<p>调用数组里的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Initializer func = inits[j];</span><br><span class="line"></span><br><span class="line">func(context.argc, context.argv, context.envp, context.apple, &amp;context.programVars);</span><br></pre></td></tr></table></figure>
<p>汇编片段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  0x1090833a0 &lt;+510&gt;:  movq   -0x68(%rbp), %r8</span><br><span class="line">    0x1090833a4 &lt;+514&gt;:  callq  *%r13</span><br><span class="line">-&gt;  0x1090833a7 &lt;+517&gt;:  testq  %r14, %r14</span><br><span class="line">    0x1090833aa &lt;+520&gt;:  jne    0x1090833c9               ; &lt;+551&gt;</span><br><span class="line">    0x1090833ac &lt;+522&gt;:  leaq   0x42e45(%rip), %rax       ; dyld::gLibSystemHelpers</span><br></pre></td></tr></table></figure>
<p>此时控制台 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read r13</span><br><span class="line"></span><br><span class="line">r13 = 0x00007fff4ff16773 libSystem.B.dylib`libSystem_initializer</span><br></pre></td></tr></table></figure>
<p>如果设置了<code>DYLD_PRINT_INITIALIZERS</code>变量，还会打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dyld: calling initializer function 0x7fff4ff16773 in /usr/lib/libSystem.B.dylib</span><br></pre></td></tr></table></figure>
<p>对应代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( context.verboseInit )</span><br><span class="line">								dyld::<span class="built_in">log</span>(<span class="string">"dyld: calling initializer function %p in %s\n"</span>, func, <span class="keyword">this</span>-&gt;getPath());</span><br></pre></td></tr></table></figure>
<p>小结：ImageLoaderMachO::doModInitFunctions方法中找到__mod_init_funcs section，通过地址加fSlide计算得到inits数组，然后调用libSystem.B.dylib`libSystem_initializer</p>
<p>ImageLoaderMachO::doModInitFunctions相关代码如下</p>
<p><strong>SECTION_TYPE</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The flags field of a section structure is separated into two parts a section</span></span><br><span class="line"><span class="comment"> * type and section attributes.  The section types are mutually exclusive (it</span></span><br><span class="line"><span class="comment"> * can only have one type) but the section attributes are not (it may have more</span></span><br><span class="line"><span class="comment"> * than one attribute).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_TYPE		 0x000000ff	<span class="comment">/* 256 section types */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_ATTRIBUTES	 0xffffff00	<span class="comment">/*  24 section attributes */</span></span></span><br></pre></td></tr></table></figure>
<p><strong>S_MOD_INIT_FUNC_POINTERS</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// darwin-xnu/EXTERNAL_HEADERS/mach-o/loader.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	S_MOD_INIT_FUNC_POINTERS	0x9	<span class="comment">/* section with only function</span></span></span><br><span class="line"><span class="meta"><span class="comment">						   pointers for initialization*/</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ImageLoaderMachO::doModInitFunctions(<span class="keyword">const</span> LinkContext&amp; context)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> ( fHasInitializers ) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">uint32_t</span> cmd_count = ((macho_header*)fMachOData)-&gt;ncmds;</span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">load_command</span>* <span class="title">const</span> <span class="title">cmds</span> = (<span class="title">struct</span> <span class="title">load_command</span>*)&amp;<span class="title">fMachOData</span>[<span class="title">sizeof</span>(<span class="title">macho_header</span>)];</span></span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">load_command</span>* <span class="title">cmd</span> = <span class="title">cmds</span>;</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; cmd_count; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( cmd-&gt;cmd == LC_SEGMENT_COMMAND ) &#123;</span><br><span class="line">				<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">macho_segment_command</span>* <span class="title">seg</span> = (<span class="title">struct</span> <span class="title">macho_segment_command</span>*)<span class="title">cmd</span>;</span></span><br><span class="line">				<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">macho_section</span>* <span class="title">const</span> <span class="title">sectionsStart</span> = (<span class="title">struct</span> <span class="title">macho_section</span>*)((<span class="title">char</span>*)<span class="title">seg</span> + <span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">macho_segment_command</span>));</span></span><br><span class="line">				<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">macho_section</span>* <span class="title">const</span> <span class="title">sectionsEnd</span> = &amp;<span class="title">sectionsStart</span>[<span class="title">seg</span>-&gt;<span class="title">nsects</span>];</span></span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">const</span> struct macho_section* sect=sectionsStart; sect &lt; sectionsEnd; ++sect) &#123;</span><br><span class="line">          <span class="comment">// #define SECTION_TYPE		 0x000000ff</span></span><br><span class="line">          <span class="comment">// 取sect-&gt;flags后两位，意为section type</span></span><br><span class="line">					<span class="keyword">const</span> <span class="keyword">uint8_t</span> type = sect-&gt;flags &amp; SECTION_TYPE;</span><br><span class="line">          <span class="comment">// #define	S_MOD_INIT_FUNC_POINTERS	0x9</span></span><br><span class="line">					<span class="keyword">if</span> ( type == S_MOD_INIT_FUNC_POINTERS ) &#123;</span><br><span class="line">						Initializer* inits = (Initializer*)(sect-&gt;addr + fSlide);</span><br><span class="line">						<span class="keyword">const</span> <span class="keyword">size_t</span> count = sect-&gt;size / <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>);</span><br><span class="line">						<span class="comment">// &lt;rdar://problem/23929217&gt; Ensure __mod_init_func section is within segment</span></span><br><span class="line">						<span class="keyword">if</span> ( (sect-&gt;addr &lt; seg-&gt;vmaddr) || (sect-&gt;addr+sect-&gt;size &gt; seg-&gt;vmaddr+seg-&gt;vmsize) || (sect-&gt;addr+sect-&gt;size &lt; sect-&gt;addr) )</span><br><span class="line">							dyld::throwf(<span class="string">"__mod_init_funcs section has malformed address range for %s\n"</span>, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">						<span class="keyword">for</span> (<span class="keyword">size_t</span> j=<span class="number">0</span>; j &lt; count; ++j) &#123;</span><br><span class="line">							Initializer func = inits[j];</span><br><span class="line">							<span class="comment">// &lt;rdar://problem/8543820&amp;9228031&gt; verify initializers are in image</span></span><br><span class="line">							<span class="keyword">if</span> ( ! <span class="keyword">this</span>-&gt;containsAddress(stripPointer((<span class="keyword">void</span>*)func)) ) &#123;</span><br><span class="line">								dyld::throwf(<span class="string">"initializer function %p not in mapped image for %s\n"</span>, func, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> ( ! dyld::gProcessInfo-&gt;libSystemInitialized ) &#123;</span><br><span class="line">								<span class="comment">// &lt;rdar://problem/17973316&gt; libSystem initializer must run first</span></span><br><span class="line">								<span class="keyword">const</span> <span class="keyword">char</span>* installPath = getInstallPath();</span><br><span class="line">								<span class="keyword">if</span> ( (installPath == <span class="literal">NULL</span>) || (<span class="built_in">strcmp</span>(installPath, libSystemPath(context)) != <span class="number">0</span>) )</span><br><span class="line">									dyld::throwf(<span class="string">"initializer in image (%s) that does not link with libSystem.dylib\n"</span>, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> ( context.verboseInit )</span><br><span class="line">								dyld::<span class="built_in">log</span>(<span class="string">"dyld: calling initializer function %p in %s\n"</span>, func, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">							<span class="keyword">bool</span> haveLibSystemHelpersBefore = (dyld::gLibSystemHelpers != <span class="literal">NULL</span>);</span><br><span class="line">							&#123;</span><br><span class="line">								dyld3::ScopedTimer(DBG_DYLD_TIMING_STATIC_INITIALIZER, (<span class="keyword">uint64_t</span>)fMachOData, (<span class="keyword">uint64_t</span>)func, <span class="number">0</span>);</span><br><span class="line">								func(context.argc, context.argv, context.envp, context.apple, &amp;context.programVars);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">bool</span> haveLibSystemHelpersAfter = (dyld::gLibSystemHelpers != <span class="literal">NULL</span>);</span><br><span class="line">							<span class="keyword">if</span> ( !haveLibSystemHelpersBefore &amp;&amp; haveLibSystemHelpersAfter ) &#123;</span><br><span class="line">								<span class="comment">// now safe to use malloc() and other calls in libSystem.dylib</span></span><br><span class="line">								dyld::gProcessInfo-&gt;libSystemInitialized = <span class="literal">true</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> <span class="keyword">if</span> ( type == S_INIT_FUNC_OFFSETS ) &#123;</span><br><span class="line">						<span class="keyword">const</span> <span class="keyword">uint32_t</span>* inits = (<span class="keyword">uint32_t</span>*)(sect-&gt;addr + fSlide);</span><br><span class="line">						<span class="keyword">const</span> <span class="keyword">size_t</span> count = sect-&gt;size / <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">						<span class="comment">// Ensure section is within segment</span></span><br><span class="line">						<span class="keyword">if</span> ( (sect-&gt;addr &lt; seg-&gt;vmaddr) || (sect-&gt;addr+sect-&gt;size &gt; seg-&gt;vmaddr+seg-&gt;vmsize) || (sect-&gt;addr+sect-&gt;size &lt; sect-&gt;addr) )</span><br><span class="line">							dyld::throwf(<span class="string">"__init_offsets section has malformed address range for %s\n"</span>, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">						<span class="keyword">if</span> ( seg-&gt;initprot &amp; VM_PROT_WRITE )</span><br><span class="line">							dyld::throwf(<span class="string">"__init_offsets section is not in read-only segment %s\n"</span>, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">						<span class="keyword">for</span> (<span class="keyword">size_t</span> j=<span class="number">0</span>; j &lt; count; ++j) &#123;</span><br><span class="line">							<span class="keyword">uint32_t</span> funcOffset = inits[j];</span><br><span class="line">							<span class="comment">// verify initializers are in TEXT segment</span></span><br><span class="line">							<span class="keyword">if</span> ( funcOffset &gt; seg-&gt;filesize ) &#123;</span><br><span class="line">								dyld::throwf(<span class="string">"initializer function offset 0x%08X not in mapped image for %s\n"</span>, funcOffset, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> ( ! dyld::gProcessInfo-&gt;libSystemInitialized ) &#123;</span><br><span class="line">								<span class="comment">// &lt;rdar://problem/17973316&gt; libSystem initializer must run first</span></span><br><span class="line">								<span class="keyword">const</span> <span class="keyword">char</span>* installPath = getInstallPath();</span><br><span class="line">								<span class="keyword">if</span> ( (installPath == <span class="literal">NULL</span>) || (<span class="built_in">strcmp</span>(installPath, libSystemPath(context)) != <span class="number">0</span>) )</span><br><span class="line">									dyld::throwf(<span class="string">"initializer in image (%s) that does not link with libSystem.dylib\n"</span>, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">							&#125;</span><br><span class="line">                            Initializer func = (Initializer)((<span class="keyword">uint8_t</span>*)<span class="keyword">this</span>-&gt;machHeader() + funcOffset);</span><br><span class="line">							<span class="keyword">if</span> ( context.verboseInit )</span><br><span class="line">								dyld::<span class="built_in">log</span>(<span class="string">"dyld: calling initializer function %p in %s\n"</span>, func, <span class="keyword">this</span>-&gt;getPath());</span><br><span class="line">							<span class="keyword">bool</span> haveLibSystemHelpersBefore = (dyld::gLibSystemHelpers != <span class="literal">NULL</span>);</span><br><span class="line">							&#123;</span><br><span class="line">								dyld3::ScopedTimer(DBG_DYLD_TIMING_STATIC_INITIALIZER, (<span class="keyword">uint64_t</span>)fMachOData, (<span class="keyword">uint64_t</span>)func, <span class="number">0</span>);</span><br><span class="line">                                func(context.argc, context.argv, context.envp, context.apple, &amp;context.programVars);</span><br><span class="line">                            &#125;</span><br><span class="line">							<span class="keyword">bool</span> haveLibSystemHelpersAfter = (dyld::gLibSystemHelpers != <span class="literal">NULL</span>);</span><br><span class="line">							<span class="keyword">if</span> ( !haveLibSystemHelpersBefore &amp;&amp; haveLibSystemHelpersAfter ) &#123;</span><br><span class="line">								<span class="comment">// now safe to use malloc() and other calls in libSystem.dylib</span></span><br><span class="line">								dyld::gProcessInfo-&gt;libSystemInitialized = <span class="literal">true</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			cmd = (<span class="keyword">const</span> struct load_command*)(((<span class="keyword">char</span>*)cmd)+cmd-&gt;cmdsize);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ImageLoaderMachO::doModInitFunctions-&gt;libSystem.B.dylib`libSystem_initializer</p>
<h4 id="从libSystem到libSystem"><a href="#从libSystem到libSystem" class="headerlink" title="从libSystem到libSystem"></a>从libSystem到libSystem</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libSystem.B.dylib`libSystem_initializer-&gt;libdispatch.dylib`libdispatch_init</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/oneGoon/Graphic/blob/master/hexo-blog/iOS%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1/os_object_init.png?raw=true" alt="_os_object_init"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">libdispatch_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"> ...</span><br><span class="line">  _dispatch_hw_config_init();</span><br><span class="line">	_dispatch_time_init();</span><br><span class="line">	_dispatch_vtable_init();</span><br><span class="line">	_os_object_init();</span><br><span class="line">	_voucher_init();</span><br><span class="line">	_dispatch_introspection_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>libdispatch_init中， dispatch进行一系列的初始化后，调用_os_object_init。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_os_object_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	_objc_init();</span><br><span class="line">	Block_callbacks_RR callbacks = &#123;</span><br><span class="line">		<span class="keyword">sizeof</span>(Block_callbacks_RR),</span><br><span class="line">		(<span class="keyword">void</span> (*)(<span class="keyword">const</span> <span class="keyword">void</span> *))&amp;objc_retain,</span><br><span class="line">		(<span class="keyword">void</span> (*)(<span class="keyword">const</span> <span class="keyword">void</span> *))&amp;objc_release,</span><br><span class="line">		(<span class="keyword">void</span> (*)(<span class="keyword">const</span> <span class="keyword">void</span> *))&amp;_os_objc_destructInstance</span><br><span class="line">	&#125;;</span><br><span class="line">	_Block_use_RR2(&amp;callbacks);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_COCOA_COMPAT</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *v = getenv(<span class="string">"OBJC_DEBUG_MISSING_POOLS"</span>);</span><br><span class="line">	<span class="keyword">if</span> (v) _os_object_debug_missing_pools = _dispatch_parse_bool(v);</span><br><span class="line">	v = getenv(<span class="string">"DISPATCH_DEBUG_MISSING_POOLS"</span>);</span><br><span class="line">	<span class="keyword">if</span> (v) _os_object_debug_missing_pools = _dispatch_parse_bool(v);</span><br><span class="line">	v = getenv(<span class="string">"LIBDISPATCH_DEBUG_MISSING_POOLS"</span>);</span><br><span class="line">	<span class="keyword">if</span> (v) _os_object_debug_missing_pools = _dispatch_parse_bool(v);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_os_object_init-&gt;_objc_init</p>
<h4 id="从libdispatch进入到objc"><a href="#从libdispatch进入到objc" class="headerlink" title="从libdispatch进入到objc"></a>从libdispatch进入到objc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _objc_init</span></span><br><span class="line"><span class="comment">* Bootstrap initialization. Registers our image notifier with dyld.</span></span><br><span class="line"><span class="comment">* Called by libSystem BEFORE library initialization time</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    static_init();</span><br><span class="line">    lock_init();</span><br><span class="line">    exception_init();</span><br><span class="line"></span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行一系列初始化</p>
<p>注册三个方法到dyld</p>
<p>registerObjCNotifiers-&gt;notifyBatchPartial</p>
<p>objc 接收到通知</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* map_images</span></span><br><span class="line"><span class="comment">* Process the given images which are being mapped in by dyld.</span></span><br><span class="line"><span class="comment">* Calls ABI-agnostic code after taking ABI-specific locks.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: write-locks runtimeLock</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">map_images(<span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> paths[],</span><br><span class="line">           <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">mutex_locker_t</span> lock(runtimeLock);</span><br><span class="line">    <span class="keyword">return</span> map_images_nolock(count, paths, mhdrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">map_images_nolock(<span class="keyword">unsigned</span> mhCount, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> mhPaths[],</span><br><span class="line">                  <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// Perform one-time runtime initialization that must be deferred until </span></span><br><span class="line">    <span class="comment">// the executable itself is found. This needs to be done before </span></span><br><span class="line">    <span class="comment">// further initialization.</span></span><br><span class="line">    <span class="comment">// (The executable may not be present in this infoList if the </span></span><br><span class="line">    <span class="comment">// executable does not contain Objective-C code but Objective-C </span></span><br><span class="line">    <span class="comment">// is dynamically loaded later.</span></span><br><span class="line">    <span class="keyword">if</span> (firstTime) &#123;</span><br><span class="line">        sel_init(selrefCount);</span><br><span class="line">        arr_init();</span><br><span class="line">      </span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">if</span> (hCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);</span><br><span class="line">    &#125;   </span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* sel_init</span></span><br><span class="line"><span class="comment">* Initialize selector tables and register selectors used internally.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sel_init</span><span class="params">(<span class="keyword">size_t</span> selrefCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">        <span class="comment">// Register selectors used by libobjc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> s(x) SEL_##x = sel_registerNameNoLock(#x, NO)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> t(x,y) SEL_##y = sel_registerNameNoLock(#x, NO)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutex_locker_t</span> lock(selLock);</span><br><span class="line"></span><br><span class="line">    s(load);</span><br><span class="line">    s(initialize);</span><br><span class="line">    t(resolveInstanceMethod:, resolveInstanceMethod);</span><br><span class="line">    t(resolveClassMethod:, resolveClassMethod);</span><br><span class="line">    t(.cxx_construct, cxx_construct);</span><br><span class="line">    t(.cxx_destruct, cxx_destruct);</span><br><span class="line">    s(retain);</span><br><span class="line">    s(release);</span><br><span class="line">    s(autorelease);</span><br><span class="line">    s(retainCount);</span><br><span class="line">    s(alloc);</span><br><span class="line">    t(allocWithZone:, allocWithZone);</span><br><span class="line">    s(dealloc);</span><br><span class="line">    s(copy);</span><br><span class="line">    s(<span class="keyword">new</span>);</span><br><span class="line">    t(forwardInvocation:, forwardInvocation);</span><br><span class="line">    t(_tryRetain, tryRetain);</span><br><span class="line">    t(_isDeallocating, isDeallocating);</span><br><span class="line">    s(retainWeakReference);</span><br><span class="line">    s(allowsWeakReference);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> s</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> t</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SEL <span class="title">sel_registerNameNoLock</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">bool</span> copy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __sel_registerName(name, <span class="number">0</span>, copy);  <span class="comment">// NO lock, maybe copy</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> NXMapTable *namedSelectors;</span><br><span class="line"><span class="keyword">static</span> SEL __sel_registerName(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">bool</span> shouldLock, <span class="keyword">bool</span> copy) </span><br><span class="line">&#123;</span><br><span class="line">    SEL result = <span class="number">0</span>;</span><br><span class="line"> ...</span><br><span class="line">    <span class="keyword">if</span> (namedSelectors) &#123;</span><br><span class="line">        result = (SEL)NXMapGet(namedSelectors, name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result) <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No match. Insert.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!namedSelectors) &#123;</span><br><span class="line">      <span class="comment">// 新建哈希表</span></span><br><span class="line">        namedSelectors = NXCreateMapTable(NXStrValueMapPrototype, </span><br><span class="line">                                          (<span class="keyword">unsigned</span>)SelrefCount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">      <span class="comment">// 查表没有命中，则插入</span></span><br><span class="line">        result = sel_alloc(name, copy);</span><br><span class="line">        <span class="comment">// fixme choose a better container (hash not map for starters)</span></span><br><span class="line">        NXMapInsert(namedSelectors, sel_getName(result), result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sel_init中的方法注册到全局静态哈希表namedSelectors，数据结构定义如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> NXHashTablePrototype	* _Nonnull prototype OBJC_HASH_AVAILABILITY;</span><br><span class="line">    <span class="keyword">unsigned</span>			count OBJC_HASH_AVAILABILITY;</span><br><span class="line">    <span class="keyword">unsigned</span>			nbBuckets OBJC_HASH_AVAILABILITY;</span><br><span class="line">    <span class="keyword">void</span>			* _Nullable buckets OBJC_HASH_AVAILABILITY;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span>			* _Nullable info OBJC_HASH_AVAILABILITY;</span><br><span class="line">   &#125; NXHashTable OBJC_HASH_AVAILABILITY;</span><br><span class="line">    <span class="comment">/* private data structure; may change */</span></span><br></pre></td></tr></table></figure>
<p>建表过程会调用到bootstrap</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bootstrap</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(<span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line">    prototypes = ALLOCTABLE (DEFAULT_ZONE);</span><br><span class="line">    prototypes-&gt;prototype = &amp;protoPrototype; </span><br><span class="line">    prototypes-&gt;count = <span class="number">1</span>;</span><br><span class="line">    prototypes-&gt;nbBuckets = <span class="number">1</span>; <span class="comment">/* has to be 1 so that the right bucket is 0 */</span></span><br><span class="line">    prototypes-&gt;buckets = ALLOCBUCKETS(DEFAULT_ZONE, <span class="number">1</span>);</span><br><span class="line">    prototypes-&gt;info = <span class="literal">NULL</span>;</span><br><span class="line">    ((HashBucket *) prototypes-&gt;buckets)[<span class="number">0</span>].count = <span class="number">1</span>;</span><br><span class="line">    ((HashBucket *) prototypes-&gt;buckets)[<span class="number">0</span>].elements.one = &amp;protoPrototype;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h5 id="arr-init"><a href="#arr-init" class="headerlink" title="arr_init"></a>arr_init</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arr_init</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage::init();</span><br><span class="line">    SideTableInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化AutoreleasePoolPage</p>
<p>初始化SideTable</p>
<h5 id="read-images"><a href="#read-images" class="headerlink" title="_read_images"></a>_read_images</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _read_images</span></span><br><span class="line"><span class="comment">* Perform initial processing of the headers in the linked </span></span><br><span class="line"><span class="comment">* list beginning with headerList. </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Called by: map_images_nolock</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock acquired by map_images</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span> _read_images(header_info **hList, <span class="keyword">uint32_t</span> hCount, <span class="keyword">int</span> totalClasses, <span class="keyword">int</span> unoptimizedTotalClasses)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Realize non-lazy classes (for +load methods and static instances)</span></span><br><span class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">        <span class="keyword">classref_t</span> *classlist = </span><br><span class="line">            _getObjc2NonlazyClassList(hi, &amp;count);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            Class cls = remapClass(classlist[i]);</span><br><span class="line">            <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hack for class __ARCLite__, which didn't get this above</span></span><br><span class="line">            ...</span><br><span class="line">            addClassTableEntry(cls);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cls-&gt;swiftMetadataInitializer()) &#123;</span><br><span class="line">                    _objc_fatal(<span class="string">"Swift class %s with a metadata initializer "</span></span><br><span class="line">                                <span class="string">"is not allowed to be non-lazy"</span>,</span><br><span class="line">                                cls-&gt;nameForLogging());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// fixme also disallow relocatable classes</span></span><br><span class="line">                <span class="comment">// We can't disallow all Swift classes because of</span></span><br><span class="line">                <span class="comment">// classes like Swift.__EmptyArrayStorage</span></span><br><span class="line">            &#125;</span><br><span class="line">            realizeClassWithoutSwift(cls);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="releaize"><a href="#releaize" class="headerlink" title="releaize"></a>releaize</h5><p>先看主体流程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* realizeClassWithoutSwift</span></span><br><span class="line"><span class="comment">* Performs first-time initialization on class cls, </span></span><br><span class="line"><span class="comment">* including allocating its read-write data.</span></span><br><span class="line"><span class="comment">* Does not perform any Swift-side initialization.</span></span><br><span class="line"><span class="comment">* Returns the real class structure for the class. </span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be write-locked by the caller</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Class <span class="title">realizeClassWithoutSwift</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">..<span class="number">.0</span></span><br><span class="line"> <span class="comment">//MARK: - 自注解 NSObject递归结束条件</span></span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> nil;</span><br><span class="line">    <span class="comment">//MARK: - 自注解 子类，元类结束条件</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;isRealized()) <span class="keyword">return</span> cls;</span><br><span class="line">..<span class="number">.1</span></span><br><span class="line">    <span class="comment">// Realize superclass and metaclass, if they aren't already.</span></span><br><span class="line">    <span class="comment">// This needs to be done after RW_REALIZED is set above, for root classes.</span></span><br><span class="line">    <span class="comment">// This needs to be done after class index is chosen, for root metaclasses.</span></span><br><span class="line">    <span class="comment">// This assumes that none of those classes have Swift contents,</span></span><br><span class="line">    <span class="comment">//   or that Swift's initializers have already been called.</span></span><br><span class="line">    <span class="comment">//   fixme that assumption will be wrong if we add support</span></span><br><span class="line">    <span class="comment">//   for ObjC subclasses of Swift classes.</span></span><br><span class="line">    <span class="comment">//MARK: - 自注解 递归确保根节点realize</span></span><br><span class="line">    supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass));</span><br><span class="line">    metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()));</span><br><span class="line">..<span class="number">.2</span></span><br><span class="line"><span class="comment">// Update superclass and metaclass in case of remapping</span></span><br><span class="line">    cls-&gt;superclass = supercls;</span><br><span class="line">    cls-&gt;initClassIsa(metacls);</span><br><span class="line"> ..<span class="number">.3</span></span><br><span class="line">  <span class="comment">// Connect this class to its superclass's subclass lists</span></span><br><span class="line">    <span class="keyword">if</span> (supercls) &#123;</span><br><span class="line">        addSubclass(supercls, cls);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//MARK: - 自注解 添加根类</span></span><br><span class="line">        addRootClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Attach categories</span></span><br><span class="line">    methodizeClass(cls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// addRootClass(cls); cls包含的类</span><br><span class="line">(Class) $0 = NSObject</span><br><span class="line">(Class) $1 = __NSAtom</span><br><span class="line">(Class) $2 = NSProxy</span><br><span class="line">&lt;main&gt;</span><br><span class="line">(Class) $3 = Object</span><br><span class="line">(Class) $4 = __NSMessageBuilder</span><br><span class="line">(Class) $5 = _NSZombie_</span><br><span class="line">(Class) $6 = __NSGenericDeallocHandler</span><br><span class="line">(Class) $7 = NSLeafProxy</span><br><span class="line">(Class) $8 = JSExport</span><br><span class="line">(Class) $9 = _CNZombie_</span><br></pre></td></tr></table></figure>
<p>可以看到，main函数前，有三个cls，NSObject, __NSAtom, NSProxy</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addRootClass</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    assert(cls-&gt;isRealized());</span><br><span class="line">    cls-&gt;data()-&gt;nextSiblingClass = _firstRealizedClass;</span><br><span class="line">    _firstRealizedClass = cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addRootClass 根类数据结构的调整，可以发现为单链表，每一次把新结点通过头插法插入到表头(_firstRealizedClass)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* addSubclass</span></span><br><span class="line"><span class="comment">* Adds subcls as a subclass of supercls.</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be held by the caller.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addSubclass</span><span class="params">(Class supercls, Class subcls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (supercls  &amp;&amp;  subcls) &#123;</span><br><span class="line">        ...</span><br><span class="line">        subcls-&gt;data()-&gt;nextSiblingClass = supercls-&gt;data()-&gt;firstSubclass;</span><br><span class="line">        supercls-&gt;data()-&gt;firstSubclass = subcls;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>addSubclass的方法与root类似，链表的表头为supercls中的firstSubclss.</p>
<p>整体结构如图 省略了尾（空）结点</p>
<p><img src="https://github.com/oneGoon/Graphic/blob/master/hexo-blog/iOS%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1/RootClass.png?raw=true" alt="rootClass"></p>
<p>追究细节，先看1处省略的代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ro = (<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *)cls-&gt;data();</span><br><span class="line">    <span class="keyword">if</span> (ro-&gt;flags &amp; RO_FUTURE) &#123;</span><br><span class="line">        <span class="comment">// This was a future class. rw data is already allocated.</span></span><br><span class="line">        rw = cls-&gt;data();</span><br><span class="line">        ro = cls-&gt;data()-&gt;ro;</span><br><span class="line">        cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Normal class. Allocate writeable class data.</span></span><br><span class="line">        rw = (<span class="keyword">class_rw_t</span> *)<span class="built_in">calloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">class_rw_t</span>), <span class="number">1</span>);</span><br><span class="line">        rw-&gt;ro = ro;</span><br><span class="line">        <span class="comment">//MARK: - 自注解 每次递归都会把路径上的cls设置一些数据 RW_REALIZED 代表isRealized，所以元类不会死循环</span></span><br><span class="line">        rw-&gt;flags = RW_REALIZED|RW_REALIZING;</span><br><span class="line">        cls-&gt;setData(rw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isMeta = ro-&gt;flags &amp; RO_META;</span><br><span class="line"></span><br><span class="line">    rw-&gt;version = isMeta ? <span class="number">7</span> : <span class="number">0</span>;  <span class="comment">// old runtime went up to 6</span></span><br></pre></td></tr></table></figure>
<p>ro的声明<strong>const</strong> class_ro_t *ro;</p>
<h6 id="ro-const-class-ro-t-cls-gt-data"><a href="#ro-const-class-ro-t-cls-gt-data" class="headerlink" title="ro = (const class_ro_t *)cls-&gt;data();"></a>ro = (const class_ro_t *)cls-&gt;data();</h6><p>当看到data()的实现不免疑惑 返回<code>rw*</code>类型，为什么要强转<code>ro*</code>类型呢? 为什么能转呢？</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class_rw_t</span> *data() &#123; </span><br><span class="line">    <span class="keyword">return</span> bits.data();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看下class_ro_t与class_rw_t的定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_ro_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceStart;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceSize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">uint32_t</span> reserved;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;</span><br><span class="line">    <span class="keyword">method_list_t</span> * baseMethodList;</span><br><span class="line">    <span class="keyword">protocol_list_t</span> * baseProtocols;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">ivar_list_t</span> * ivars;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * weakIvarLayout;</span><br><span class="line">    <span class="keyword">property_list_t</span> *baseProperties;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// Be warned that Symbolication knows the layout of this structure.</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">method_array_t</span> methods;</span><br><span class="line">    <span class="keyword">property_array_t</span> properties;</span><br><span class="line">    <span class="keyword">protocol_array_t</span> protocols;</span><br><span class="line"></span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *demangledName;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_INDEXED_ISA</span></span><br><span class="line">    <span class="keyword">uint32_t</span> index;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ro 9<code>*</code>8字节，rw 8<code>*</code>8字节</p>
<p>这得从编译时说起</p>
<p>编译时还没有rw，看下ro的结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> instanceStart;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> instanceSize;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *ivarLayout;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">method_list_t</span> *<span class="title">baseMethods</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">objc_protocol_list</span> *<span class="title">baseProtocols</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ivar_list_t</span> *<span class="title">ivars</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *weakIvarLayout;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">prop_list_t</span> *<span class="title">properties</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">isa</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">superclass</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *cache;</span><br><span class="line">	<span class="keyword">void</span> *vtable;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">class_ro_t</span> *<span class="title">ro</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对比运行时objc_class的数据结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line"> <span class="comment">// Class ISA;</span></span><br><span class="line"> Class superclass;</span><br><span class="line"> <span class="keyword">cache_t</span> cache;           </span><br><span class="line"> <span class="keyword">class_data_bits_t</span> bits;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">mask_t</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cache_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bucket_t</span> *_<span class="title">buckets</span>;</span></span><br><span class="line">    <span class="keyword">mask_t</span> _mask;</span><br><span class="line">    <span class="keyword">mask_t</span> _occupied;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------展开后----------</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> &#123;</span></span><br><span class="line">  <span class="keyword">isa_t</span> isa;</span><br><span class="line">  Class superclass;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bucket_t</span> *_<span class="title">buckets</span>;</span></span><br><span class="line">  <span class="keyword">uint32_t</span> _mask;</span><br><span class="line">  <span class="keyword">uint32_t</span> _occupied;</span><br><span class="line">  <span class="keyword">class_data_bits_t</span> bits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比数据结构_class_t与objc_class 发现</p>
<p>objc_class的bits对应于_class_t的ro</p>
<p>就此清晰了，编译时确定的ro结构，在运行时初始化类时通过objc_class的data方法获取到有效的地址接下来会赋给新建的rw。</p>
<h5 id="methodizeClass"><a href="#methodizeClass" class="headerlink" title="methodizeClass"></a>methodizeClass</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* methodizeClass</span></span><br><span class="line"><span class="comment">* Fixes up cls's method list, protocol list, and property list.</span></span><br><span class="line"><span class="comment">* Attaches any outstanding categories.</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock must be held by the caller</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">methodizeClass</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br></pre></td></tr></table></figure>
<p>method_list_t</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// Two bits of entsize are used for fixup markers.</span><br><span class="line">struct method_list_t : entsize_list_tt&lt;method_t, method_list_t, 0x3&gt; &#123;</span><br><span class="line">    bool isFixedUp() const;</span><br><span class="line">    void setFixedUp();</span><br><span class="line"></span><br><span class="line">    uint32_t indexOfMethod(const method_t *meth) const &#123;</span><br><span class="line">        uint32_t i = </span><br><span class="line">            (uint32_t)(((uintptr_t)meth - (uintptr_t)this) / entsize());</span><br><span class="line">        assert(i &lt; count);</span><br><span class="line">        return i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* entsize_list_tt&lt;Element, List, FlagMask&gt;</span></span><br><span class="line"><span class="comment">* Generic implementation of an array of non-fragile structs.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Element is the struct type (e.g. method_t)</span></span><br><span class="line"><span class="comment">* List is the specialization of entsize_list_tt (e.g. method_list_t)</span></span><br><span class="line"><span class="comment">* FlagMask is used to stash extra bits in the entsize field</span></span><br><span class="line"><span class="comment">*   (e.g. method list fixup markers)</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Element, <span class="keyword">typename</span> List, <span class="keyword">uint32_t</span> FlagMask&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">entsize_list_tt</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> entsizeAndFlags;</span><br><span class="line">    <span class="keyword">uint32_t</span> count;</span><br><span class="line">    Element first;</span><br></pre></td></tr></table></figure>
<h1 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h1><p>malloc </p>
<p>c++的atuo 根据表达式推断出数据类型 </p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/14/逆向/" rel="next" title="逆向">
                <i class="fa fa-chevron-left"></i> 逆向
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/19/汇编篇/" rel="prev" title="汇编篇">
                汇编篇 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">douCodeLife</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-6"><a class="nav-link" href="#class-t"><span class="nav-number">1.</span> <span class="nav-text">_class_t</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SETUP-AlanWang"><span class="nav-number">2.</span> <span class="nav-text">SETUP AlanWang</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SETUP-Human"><span class="nav-number">3.</span> <span class="nav-text">SETUP Human</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#class-ro-t"><span class="nav-number">4.</span> <span class="nav-text">_class_ro_t</span></a></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#运行时体系结构（Runtime-Architecture）"><span class="nav-number"></span> <span class="nav-text">运行时体系结构（Runtime Architecture）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对象的诞生"><span class="nav-number"></span> <span class="nav-text">对象的诞生</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#运行时类的结构"><span class="nav-number"></span> <span class="nav-text">运行时类的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Meta-元类"><span class="nav-number">1.</span> <span class="nav-text">Meta 元类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#宏"><span class="nav-number"></span> <span class="nav-text">宏</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#objc-config-h中的宏"><span class="nav-number"></span> <span class="nav-text">objc-config.h中的宏</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LP64"><span class="nav-number"></span> <span class="nav-text">__LP64__</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#arm"><span class="nav-number"></span> <span class="nav-text">__arm__</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SUPPORT-PACKED-ISA"><span class="nav-number"></span> <span class="nav-text">SUPPORT_PACKED_ISA</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SUPPORT-TAGGED-POINTERS"><span class="nav-number"></span> <span class="nav-text">SUPPORT_TAGGED_POINTERS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SUPPORT-INDEXED-ISA"><span class="nav-number"></span> <span class="nav-text">SUPPORT_INDEXED_ISA</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SUPPORT-PACKED-ISA-1"><span class="nav-number"></span> <span class="nav-text">SUPPORT_PACKED_ISA</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SUPPORT-NONPOINTER-ISA"><span class="nav-number"></span> <span class="nav-text">SUPPORT_NONPOINTER_ISA</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SUPPORT-FIXUP"><span class="nav-number"></span> <span class="nav-text">SUPPORT_FIXUP</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SUPPORT-ZEROCOST-EXCEPTIONS"><span class="nav-number"></span> <span class="nav-text">SUPPORT_ZEROCOST_EXCEPTIONS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ISA-BITFIELD-RC-ONE-RC-HALF"><span class="nav-number"></span> <span class="nav-text">ISA_BITFIELD, RC_ONE, RC_HALF</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ISA-MAGIC-VALUE"><span class="nav-number"></span> <span class="nav-text">ISA_MAGIC_VALUE</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TaggedPointer"><span class="nav-number"></span> <span class="nav-text">TaggedPointer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流程"><span class="nav-number"></span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#从dyld进入到libSystem"><span class="nav-number"></span> <span class="nav-text">从dyld进入到libSystem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从libSystem到libSystem"><span class="nav-number"></span> <span class="nav-text">从libSystem到libSystem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从libdispatch进入到objc"><span class="nav-number"></span> <span class="nav-text">从libdispatch进入到objc</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#arr-init"><span class="nav-number"></span> <span class="nav-text">arr_init</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#read-images"><span class="nav-number"></span> <span class="nav-text">_read_images</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#releaize"><span class="nav-number"></span> <span class="nav-text">releaize</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ro-const-class-ro-t-cls-gt-data"><span class="nav-number">1.</span> <span class="nav-text">ro = (const class_ro_t *)cls-&gt;data();</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#methodizeClass"><span class="nav-number"></span> <span class="nav-text">methodizeClass</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#名词"><span class="nav-number"></span> <span class="nav-text">名词</span></a></li></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">douCodeLife</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

  

</body>
</html>
